apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
  namespace: {{ .Release.Namespace }}
  labels:
    app: jenkins
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app: jenkins
  template:
    metadata:
      labels:
        app: jenkins
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/prometheus"
    spec:
      serviceAccountName: jenkins
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
      containers:
        - name: jenkins
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: JAVA_OPTS
              value: >-
                -Djenkins.install.runSetupWizard=false
                -Dhudson.model.DirectoryBrowserSupport.CSP="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
            - name: JENKINS_OPTS
              value: "--prefix=/jenkins"
            {{- if .Values.casc.enabled }}
            - name: CASC_JENKINS_CONFIG
              value: /var/jenkins_config/jenkins.yaml
            {{- end }}
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
            - name: agent
              containerPort: 50000
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /jenkins/login
              port: http
            initialDelaySeconds: 120
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 10
          readinessProbe:
            httpGet:
              path: /jenkins/login
              port: http
            initialDelaySeconds: 90
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 10
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          volumeMounts:
            - name: jenkins-home
              mountPath: /var/jenkins_home
            {{- if .Values.casc.enabled }}
            - name: jenkins-casc-config
              mountPath: /var/jenkins_config
            {{- end }}
            {{- if .Values.jobs.enabled }}
            - name: jenkins-jobs
              mountPath: /var/jenkins_jobs
            {{- end }}
      volumes:
        - name: jenkins-home
          {{- if .Values.persistence.enabled }}
          persistentVolumeClaim:
            claimName: jenkins-home
          {{- else }}
          emptyDir: {}
          {{- end }}
        {{- if .Values.casc.enabled }}
        - name: jenkins-casc-config
          configMap:
            name: jenkins-casc-config
        {{- end }}
        {{- if .Values.jobs.enabled }}
        - name: jenkins-jobs
          configMap:
            name: jenkins-jobs
        {{- end }}

